<!DOCTYPE html>
<html lang="en">
  <head>
    <title></title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>starcoder.js</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <div class="container">
      <h1>starcoder.jsüåü</h1>

      <p>
        ‚ö†Ô∏è<strong><i>This is an Experimental Project and might not run in all the browsers.</i></strong>‚ö†Ô∏è
      </p>

      <p id="paragraph">
        This project brings

        <a
          target="_blank"
          rel="noopener noreferrer"
          href="https://github.com/bigcode-project/starcoder.cpp"
          >starcoder.cpp
        </a>

        to browser with power of WebAssembly

        <svg
          xmlns="http://www.w3.org/2000/svg"
          version="1.1"
          width="25"
          height="25"
          viewBox="0 0 612 612"
        >
          <!-- Block -->
          <path
            d="m376 0c0 1.08 0 2.16 0 3.3 0 38.76-31.42 70.17-70.17 70.17-38.76 0-70.17-31.42-70.17-70.17l0 0c0-1.14 0-2.22 0-3.3L0 0l0 612 612 0 0-612z"
            fill="#654ff0"
          />
          <!-- Letters -->
          <path
            d="m142.16 329.81 40.56 0 27.69 147.47 0.5 0 33.28-147.47 37.94 0 30.06 149.28 0.59 0 31.56-149.28 39.78 0-51.69 216.69-40.25 0-29.81-147.47-0.78 0-31.91 147.47-41 0zm287.69 0 63.94 0 63.5 216.69-41.84 0-13.81-48.22-72.84 0-10.66 48.22-40.75 0zm24.34 53.41-17.69 79.5 55.06 0-20.31-79.5z"
            fill="#fff"
          />
        </svg>
      </p>

      <p>
        The framework provides support for loading any of the
        <strong>starcoder</strong> series model on browser.
      </p>

      <p>
        Model has to be quantized in GGML format and pre-loaded into <i>main.data</i> file. 
        You can find instructions on how to quantize a model in this project's Github repository.
      </p>

      <p>
        In this demo, <strong>tiny_starcoder_py</strong> model (184M) is first downloaded & loaded into the browser through WASM.
      </p>

      <p>
        Once the model has been loaded successfully, then you can paste in Python Code snippet for auto-completion.
      </p>

      <h3>Links</h3>
      <p>
        <a
          target="_blank"
          rel="noopener noreferrer"
          href="https://github.com/rahuldshetty/starcoder.js"
          style="all: unset; cursor: pointer; font-size: 0.9em"
        >
          <i class="fa-brands fa-github fa-xl"></i>
          Source Code
        </a>
      </p>

      <p>
        <a
          target="_blank"
          rel="noopener noreferrer"
          href="https://huggingface.co/bigcode/tiny_starcoder_py"
          style="all: unset; cursor: pointer; font-size: 0.9em"
        >
          ü§ó tiny_starcoder_py
        </a>
      </p>
    
      <h2>Demo</h2>
      
      <div class="spinner" id="spinner"></div>
      <div class="emscripten" id="status"></div>
      <progress value="0" max="100" id="progress" hidden="1"></progress>

      <form onsubmit="event.preventDefault();">
        <label for="textInput">Write Python Code to auto-complete</label>
        <textarea id="textInput" name="textInput" rows="4" cols="50">
def fibonacci(</textarea
        >

        <button id="submitBtn" disabled>
            Generate
        </button>
      </form>
     
      <div id="result" style="display:none;">
        <h3>Result</h3>
        <pre><code id="output"></code></pre>
      </div>
    </div>

    <script type="module">
      const worker = new Worker("./worker-modified-main.js", { type: "module" });

      // import { callMain, Module as mod } from "./modified-main.js";

      let output = document.getElementById("output");
      let submitButton = document.getElementById("submitBtn");
      let spinnerElement = document.getElementById("spinner");
      let statusElement = document.getElementById("status");
      let progressElement = document.getElementById("progress");
      let resultSection = document.getElementById("result");


      let default_args = [
        //'-p', 'def fibonnaci(',
        //'-t', '4',
        // '--top_k', '0',
        "--top_p", "0.85",
        "--temp", "0.2",
        "-n", "50",
      ];

      const filter_output = (text) => {
        if(text){
            if (
                text.startsWith("main:") || 
                text.startsWith("starcoder_model_load:")
            ){
                return false;
            }
            return true;
        } else {
            return false;
        }
      }

      const set_module = (key, func) => {
        worker.postMessage({
            type: 'setModule',
            property: key,
            value: func
        });
      }

      const call_module = (func, ...params) => {
        worker.postMessage({
            type: 'callModule',
            property: func,
            value: params
        });
      }

      set_module('print', (text) => {
        console.log("stdout: " + text);
        // show output only when required
        if(filter_output(text)){
            document.getElementById("output").textContent  += text + "\n";

            if (resultSection.hasAttribute("style"))
                resultSection.style.removeProperty("display");
        }
      });

      set_module("totalDependencies", 0);

      set_module("setStatus", (text) => {
        if (!mod.setStatus.last)
          mod.setStatus.last = { time: Date.now(), text: "" };
        if (text === mod.setStatus.last.text) return;
        var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
        var now = Date.now();
        if (m && now - mod.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
        mod.setStatus.last.time = now;
        mod.setStatus.last.text = text;
        if (m) {
          text = m[1];
          progressElement.value = parseInt(m[2]) * 100;
          progressElement.max = parseInt(m[4]) * 100;
          progressElement.hidden = false;
          spinnerElement.hidden = false;
        } else {
          progressElement.value = null;
          progressElement.max = null;
          progressElement.hidden = true;
          if (!text) spinnerElement.style.display = "none";
        }
        statusElement.innerHTML = text;
      });

      set_module("monitorRunDependencies", (left) => {
        mod.totalDependencies = Math.max(mod.totalDependencies, left);
        call_module('setStatus',
          left
            ? "Preparing... (" +
                (mod.totalDependencies - left) +
                "/" +
                mod.totalDependencies +
                ")"
            : "All downloads complete."
        );
        if (!left) {
          submitButton.disabled = false;
        } else {
          submitButton.disabled = true;
          resultSection.style.display = 'none';
        }
      });

      async function runMain() {
        document.getElementById("output").textContent = ""
        submitButton.disabled = true;
        const text = document.getElementById("textInput").value;
        callMain(default_args.concat(["-p", text]));
        submitButton.disabled = false;
      }

      submitButton.addEventListener("click", runMain);

      window.onerror = (event) => {
        // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
        call_module('setStatus', "Exception thrown, see JavaScript console");
        spinnerElement.style.display = "none";
        set_module('setStatus', (text) => {
          if (text) console.error("[post-exception status] " + text);
        });
      };
    </script>
  </body>
</html>
